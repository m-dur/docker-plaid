@startuml Account Linking Process

skinparam {
    BackgroundColor white
    ArrowColor black
    ActorBorderColor black
    LifelineBackgroundColor white
}

actor User
participant "Frontend" as FE
participant "Flask App" as App
participant "Plaid Link" as PlaidLink
participant "Plaid API" as PlaidAPI
participant "FinancialDataHandler" as Handler
database "PostgreSQL" as DB
database "access_tokens.json" as TokenFile

User -> FE: Click "Link Account"
activate FE

FE -> PlaidLink: Initialize Plaid Link
activate PlaidLink

PlaidLink -> User: Display institution selection
User -> PlaidLink: Select institution & login
PlaidLink -> PlaidAPI: Authenticate
PlaidAPI --> PlaidLink: Return public_token
PlaidLink --> FE: onSuccess(public_token)

FE -> App: POST /exchange_public_token
activate App

App -> PlaidAPI: Exchange public_token
PlaidAPI --> App: Return access_token

App -> Handler: fetch_and_process_financial_data
activate Handler

Handler -> PlaidAPI: Get institution info
Handler -> PlaidAPI: Get accounts
Handler -> PlaidAPI: Get balances
Handler -> PlaidAPI: Get transactions

Handler -> DB: Save institution data
Handler -> DB: Save account data
Handler -> DB: Save transaction data

Handler --> App: Return results
deactivate Handler

App -> TokenFile: Save access_token
App --> FE: Return success
deactivate App

FE --> User: Reload page
deactivate FE

note right of App
  Reference: app/app.py
  startLine: 54
  endLine: 101
end note

@enduml 