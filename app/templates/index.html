<html>
<!--=================================================
    STYLES AND PAGE INSTRUCTIONS. IGNORE THIS STUFF
    =================================================-->
<head>
  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap" rel="stylesheet">
  <style>
    .outer { justify-self: center; margin: 20% auto 120px auto; width: 60%; font-family: 'Roboto', sans-serif; }
    a { text-decoration: underline; }
    li { padding-left: 1rem; }
    button { background-color: white; border: 1px solid #0A85EA; color: black; padding: 12px 32px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); cursor: pointer; }
    #results { margin-top: 20px; border: 1px solid #ddd; padding: 10px; }
    .institutions-list { margin-bottom: 20px; }
    .institution-info { 
        background: #f5f5f5; 
        padding: 10px; 
        margin: 10px 0; 
        border-radius: 4px; 
    }
    .remove-institution {
        background-color: #ff4444;
        color: white;
        border: none;
        padding: 8px 16px;
        margin-top: 10px;
        border-radius: 4px;
        cursor: pointer;
    }
    .remove-institution:hover {
        background-color: #cc0000;
    }
    .institution-results {
        background: #f5f5f5;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
    }
    .totals-section {
        margin-top: 20px;
        padding: 15px;
        background: #e0e0e0;
        border-radius: 4px;
    }
    .institution-results h3, .totals-section h3 {
        margin-top: 0;
        color: #333;
    }
    .nav-link {
        display: inline-block;
        margin: 10px 0;
        padding: 8px 16px;
        background-color: #0A85EA;
        color: white;
        text-decoration: none;
        border-radius: 4px;
    }
    .nav-link:hover {
        background-color: #0969c5;
    }
    .schema-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
        padding: 30px;
        overflow-x: auto;
    }
    .table-box {
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin: 10px;
        min-width: 250px;
        vertical-align: top;
    }
    .table-name {
        background: #f5f5f5;
        padding: 10px;
        border-bottom: 1px solid #ccc;
        font-weight: bold;
    }
    .table-columns {
        padding: 10px;
    }
    .column {
        color: #333;
        margin: 4px 0;
        font-family: monospace;
    }
    .column.primary-key {
        color: #d63384;
        font-weight: bold;
    }
    .column.foreign-key {
        color: #0d6efd;
        text-decoration: underline;
    }
    .relationships-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        margin: 20px 0;
    }
    .relationships-table th, .relationships-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    .relationships-table th {
        background-color: #f5f5f5;
        font-weight: bold;
    }
    .table-container {
        overflow-x: auto;
        margin: 20px 0;
    }
    .institution-container {
        display: flex;
        gap: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .institution-metadata {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
        min-width: 300px;
    }

    .metadata-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .metadata-item {
        display: flex;
        flex-direction: column;
    }

    .metadata-item .label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .metadata-item .value {
        font-weight: 500;
        color: #212529;
    }

    .metadata-sections {
        display: flex;
        gap: 2rem;
    }
    
    .institution-metadata,
    .account-data {
        flex: 1;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 6px;
    }
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-spinner {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #0A85EA;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        color: white;
        margin-top: 20px;
        font-size: 18px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .database-stats {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-width: 300px;
        z-index: 1000;
    }
    
    .database-stats h4 {
        margin: 0 0 10px 0;
        color: #333;
        border-bottom: 2px solid #0A85EA;
        padding-bottom: 5px;
    }
    
    .table-stats {
        font-size: 0.9rem;
        width: 100%;
    }
    
    .table-stats tr {
        border-bottom: 1px solid #eee;
    }
    
    .table-stats td {
        padding: 4px 0;
    }
    
    .table-stats td:last-child {
        text-align: right;
        font-weight: bold;
        color: #0A85EA;
    }

    .schema-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
        padding: 20px;
    }

    #database-stats-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    #database-stats-table th,
    #database-stats-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    #database-stats-table th {
        background-color: #f5f5f5;
        font-weight: bold;
    }

    #database-stats-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .table-stats td.view-name {
        font-style: italic;
        color: #666;
    }
    .table-stats td.table-name {
        color: #333;
    }

    .error-container {
        background-color: #fee;
        border: 1px solid #fcc;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
    }

    .error-title {
        color: #c00;
        font-weight: bold;
        margin: 0 0 10px 0;
    }

    .error-message {
        color: #333;
        margin: 5px 0;
    }

    .error-details {
        color: #666;
        font-size: 0.9em;
        margin: 5px 0;
    }

    .error-time {
        color: #999;
        font-size: 0.8em;
        margin: 5px 0 0 0;
    }
  </style>
</head>
<body style="background-color:#B1EEFC;">
  <div class="database-stats">
    <h4>Database Statistics</h4>
    <table class="table-stats" id="database-stats-table">
      <tbody>
        <tr><td colspan="2">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="outer">
    <h1>Financial Data Fetcher</h1>
    <a href="/data" class="nav-link">View Data</a>
    <a href="/transactions" class="nav-link">View Transactions</a>
    <a href="/expenses" class="nav-link">View Expenses</a>
    <a href="/expenses/group" class="nav-link">View Expenses by Group</a>
    <a href="/income" class="nav-link">Income Analysis</a>
    <a href="/net_income" class="nav-link">Net Income Analysis</a>
    <a href="/cashflow" class="nav-link">Cash Flow Analysis</a>
    <a href="/balances" class="nav-link">Credit Card Balances</a>
    {% if institutions %}
    <div class="institutions-list">
        <h3>Connected Institutions:</h3>
        {% for institution in institutions %}
        <div class="institution-container">
            <div class="institution-info">
                <p>Connected Institution: <strong>{{ institution.name }}</strong></p>
                <p>Institution ID: <code>{{ institution.id }}</code></p>
                <button class="remove-institution" data-institution-id="{{ institution.id }}">
                    Remove Institution
                </button>
            </div>
            <div class="metadata-sections">
                <div class="institution-metadata" id="metadata-{{ institution.id }}">
                    <h4>Account Status</h4>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <span class="label">Last Transaction</span>
                            <span class="value" id="last-transaction-{{ institution.id }}">Loading...</span>
                        </div>
                        <div class="metadata-item">
                            <span class="label">Last Refresh</span>
                            <span class="value" id="last-refresh-{{ institution.id }}">Loading...</span>
                        </div>
                        <div class="metadata-item">
                            <span class="label">New Transactions</span>
                            <span class="value" id="last-credit-{{ institution.id }}">Loading...</span>
                        </div>
                        <div class="metadata-item">
                            <span class="label">Connected On</span>
                            <span class="value" id="connected-on-{{ institution.id }}">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="account-data" id="account-data-{{ institution.id }}">
                    <h4>Account Data</h4>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <span class="label">Connected Accounts</span>
                            <span class="value" id="account-count-{{ institution.id }}">Loading...</span>
                        </div>
                        <div class="metadata-item">
                            <span class="label">Total Transactions</span>
                            <span class="value" id="transaction-count-{{ institution.id }}">Loading...</span>
                        </div>
                        <div class="metadata-item">
                            <span class="label">Uncategorized Transactions</span>
                            <span class="value" id="uncategorized-count-{{ institution.id }}">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <button id="link-button">Link New Account</button>
    <button id="fetch-data-button" {% if not institutions %}style="display: none"{% endif %}>
        Fetch Financial Data
    </button>
    <div id="results"></div>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing your request...</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <div class="table-container">
    <div class="schema-container">
        <h2 class="schema-title">Database Schema</h2>
        {{ schema_diagram | safe }}
        <div class="schema-legend">
            <div class="legend-item">
                <span class="legend-icon">🔑</span> Primary Key
            </div>
            <div class="legend-item">
                <span class="legend-icon">🔗</span> Foreign Key
            </div>
        </div>
    </div>
  </div>
  <script type="text/javascript">
  (function($) {
    let handler = null;

    async function initializePlaidHandler() {
        // Force cleanup of any existing handler
        if (handler) {
            await handler.destroy();
            handler = null;
        }
        
        // Wait for any pending operations to complete
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const response = await fetch('/create_link_token');
        const data = await response.json();
        
        return Plaid.create({
            token: data.link_token,
            onSuccess: async (public_token, metadata) => {
                handler = null;  // Clear the handler immediately
                await handlePlaidSuccess(public_token, metadata);
            },
            onExit: async () => {
                handler = null;  // Clear the handler on exit
            },
            onLoad: () => {
                console.log('Plaid handler loaded successfully');
            }
        });
    }

    // Separate success handler function
    async function handlePlaidSuccess(public_token, metadata) {
        console.log('=== Plaid Link Success ===');
        $('.loading-overlay').css('display', 'flex');
        $('.loading-text').text('Linking your account...');
        
        const maxRetries = 3;
        let retryCount = 0;
        
        try {
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch('/exchange_public_token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            public_token: public_token,
                            metadata: metadata
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    
                    const data = await response.json();
                    
                    // First check if institutions-list exists, if not create it
                    if ($('.institutions-list').length === 0) {
                        $('.outer').prepend('<div class="institutions-list"><h3>Connected Institutions:</h3></div>');
                    }

                    // Create the new institution HTML
                    const institutionHtml = `
                        <div class="institution-container">
                            <div class="institution-info">
                                <p>Connected Institution: <strong>${metadata.institution.name}</strong></p>
                                <p>Institution ID: <code>${data.institution_id}</code></p>
                                <button class="remove-institution" data-institution-id="${data.institution_id}">
                                    Remove Institution
                                </button>
                            </div>
                            <div class="metadata-sections">
                                <div class="institution-metadata" id="metadata-${data.institution_id}">
                                    <h4>Account Status</h4>
                                    <div class="metadata-grid">
                                        <div class="metadata-item">
                                            <span class="label">Last Transaction</span>
                                            <span class="value" id="last-transaction-${data.institution_id}">Never</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="label">Last Refresh</span>
                                            <span class="value" id="last-refresh-${data.institution_id}">Never</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="label">New Transactions</span>
                                            <span class="value" id="last-credit-${data.institution_id}">0 new transactions</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="label">Connected On</span>
                                            <span class="value" id="connected-on-${data.institution_id}">${new Date().toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="account-data" id="account-data-${data.institution_id}">
                                    <h4>Account Data</h4>
                                    <div class="metadata-grid">
                                        <div class="metadata-item">
                                            <span class="label">Connected Accounts</span>
                                            <span class="value" id="account-count-${data.institution_id}">0</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="label">Total Transactions</span>
                                            <span class="value" id="transaction-count-${data.institution_id}">0</span>
                                        </div>
                                        <div class="metadata-item">
                                            <span class="label">Uncategorized Transactions</span>
                                            <span class="value" id="uncategorized-count-${data.institution_id}">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add the new institution to the list
                    $('.institutions-list').append(institutionHtml);

                    // Show the fetch button
                    $('#fetch-data-button').show();

                    try {
                        // Fetch and update the institution metadata
                        await updateInstitutionMetadata(data.institution_id);
                        // Update database statistics
                        await updateDatabaseStatistics();
                    } catch (metadataError) {
                        console.error('Error updating metadata:', metadataError);
                        // Continue even if metadata update fails
                    }

                    // Reattach event listeners
                    attachEventListeners();
                    
                    return; // Success case
                    
                } catch (error) {
                    console.error(`Attempt ${retryCount + 1} failed:`, error);
                    retryCount++;
                    
                    if (retryCount === maxRetries) {
                        $('#results').html(`
                            <div class="error-container">
                                <p class="error-title">Error linking account:</p>
                                <p class="error-message">${error.message}</p>
                                <p class="error-time">Time: ${new Date().toLocaleString()}</p>
                            </div>
                        `);
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                }
            }
        } finally {
            // Always hide the loading overlay
            $('.loading-overlay').hide();
        }
    }

    // Update the updateInstitutionMetadata function to be more robust
    async function updateInstitutionMetadata(institutionId) {
        try {
            const response = await fetch(`/api/institution_metadata/${institutionId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch institution metadata');
            }
            
            const data = await response.json();
            
            // Update all metadata fields
            const fields = {
                'last-transaction': data.last_transaction ? new Date(data.last_transaction).toLocaleString() : 'Never',
                'last-refresh': data.last_refresh ? new Date(data.last_refresh).toLocaleString() : 'Never',
                'last-credit': `${data.new_transactions} new transactions`,
                'connected-on': data.connected_on ? new Date(data.connected_on).toLocaleString() : 'Never',
                'account-count': data.account_count || 0,
                'transaction-count': data.transaction_count || 0,
                'uncategorized-count': data.uncategorized_count || 0
            };

            Object.entries(fields).forEach(([field, value]) => {
                const element = document.getElementById(`${field}-${institutionId}`);
                if (element) {
                    element.textContent = value;
                }
            });

        } catch (error) {
            console.error('Error updating institution metadata:', error);
        }
    }

    // Add new function to update page content
    async function updatePageContent() {
        try {
            // Fetch updated institutions list
            const response = await fetch('/get_institutions');
            const data = await response.json();
            
            if (!data.institutions) {
                throw new Error('No institutions data received');
            }
            
            // Update the institutions list HTML
            const institutionsHtml = data.institutions.map(institution => `
                <div class="institution-container">
                    <div class="institution-info">
                        <p>Connected Institution: <strong>${institution.name}</strong></p>
                        <p>Institution ID: <code>${institution.id}</code></p>
                        <button class="remove-institution" data-institution-id="${institution.id}">
                            Remove Institution
                        </button>
                    </div>
                    <div class="metadata-sections">
                        <!-- Add your metadata sections here -->
                        ${generateMetadataHtml(institution)}
                    </div>
                </div>
            `).join('');
            
            // Update the DOM
            $('.institutions-list').html(`
                <h3>Connected Institutions:</h3>
                ${institutionsHtml}
            `);
            
            // Show/hide fetch button based on institutions
            $('#fetch-data-button').toggle(data.institutions.length > 0);
            
            // Update metadata for each institution
            data.institutions.forEach(inst => {
                updateInstitutionMetadata(inst.id);
            });
            
            // Reattach event listeners
            attachEventListeners();
            
        } catch (error) {
            console.error('Error updating page content:', error);
            $('#results').html(`
                <div class="error-container">
                    <p class="error-title">Error updating page:</p>
                    <p class="error-message">${error.message}</p>
                </div>
            `);
        }
    }

    // Helper function to generate metadata HTML
    function generateMetadataHtml(institution) {
        return `
            <div class="institution-metadata" id="metadata-${institution.id}">
                <h4>Account Status</h4>
                <div class="metadata-grid">
                    <!-- Add your metadata items here -->
                    <div class="metadata-item">
                        <span class="label">Last Transaction</span>
                        <span class="value" id="last-transaction-${institution.id}">Loading...</span>
                    </div>
                    <!-- Add other metadata items -->
                </div>
            </div>
            <div class="account-data" id="account-data-${institution.id}">
                <!-- Similar structure for account data -->
            </div>
        `;
    }

    // Function to reattach event listeners
    function attachEventListeners() {
        $('.remove-institution').off('click').on('click', function() {
            const institutionId = $(this).data('institution-id');
            // Your existing remove institution code
        });
    }

    // Add click handler for link button
    $('#link-button').on('click', async function() {
        if (handler) return;  // Prevent multiple handlers
        
        try {
            handler = await initializePlaidHandler();
            handler.open();
        } catch (error) {
            console.error('Failed to initialize Plaid:', error);
            handler = null;
        }
    });

    $('#fetch-data-button').on('click', function(e) {
        // Show loading overlay
        $('.loading-overlay').css('display', 'flex');
        $('.loading-text').text('Fetching financial data...');
        
        $.ajax({
            url: '/fetch_financial_data',
            method: 'POST',
            contentType: 'application/json',
            success: function(data) {
                console.log('Response data:', data);
                if (data.needs_reauth) {
                    $('#results').html('<p>' + data.message + '</p>');
                    $('#link-button').show();
                    $('#fetch-data-button').hide();
                    $('.loading-overlay').hide();
                    return;
                }
                
                // Update metadata for all institutions
                const institutions = document.querySelectorAll('.institution-container');
                institutions.forEach(inst => {
                    const institutionId = inst.querySelector('.remove-institution').dataset.institutionId;
                    updateInstitutionMetadata(institutionId);
                });
                
                // Update database statistics immediately
                updateDatabaseStatistics();
                
                // Hide loading overlay after a short delay
                setTimeout(() => {
                    $('.loading-overlay').hide();
                    $('#results').empty();
                }, 500);
            },
            error: function(xhr, status, error) {
                console.error('Error details:', {
                    status: xhr.status,
                    responseText: xhr.responseText,
                    error: error
                });
                $('.loading-overlay').hide();
                
                let errorMessage = 'An error occurred while fetching data. ';
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage += response.error || response.message || error;
                } catch (e) {
                    errorMessage += error;
                }
                
                $('#results').html(`<p class="error-message">${errorMessage}</p>`);
            }
        });
    });

    $(document).ready(function() {
        // Show fetch button if we have any institutions
        if ($('.institution-info').length > 0) {
            $('#fetch-data-button').show();
        }
        $('.remove-institution').on('click', function() {
            const institutionId = $(this).data('institution-id');
            $('.loading-overlay').css('display', 'flex');
            $('.loading-text').text('Removing institution...');
            
            $.ajax({
                url: '/remove_institution',
                method: 'POST',
                data: JSON.stringify({ institution_id: institutionId }),
                contentType: 'application/json',
                success: function() {
                    // Clean up the Plaid handler before reloading
                    if (handler) {
                        handler.destroy();
                        handler = null;
                    }
                    
                    // Update database statistics first
                    updateDatabaseStatistics()
                        .then(() => {
                            // Then force a complete page reload
                            window.location.href = window.location.href;
                        })
                        .catch(error => {
                            console.error('Error updating statistics:', error);
                            // Still reload the page even if statistics update fails
                            window.location.href = window.location.href;
                        });
                },
                error: function(xhr) {
                    $('.loading-overlay').hide();
                    let errorMessage = 'Error removing institution. ';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage += response.error || 'Please try again.';
                    } catch (e) {
                        errorMessage += 'Please try again.';
                    }
                    alert(errorMessage);
                }
            });
        });
    });
  })(jQuery);
  </script>
  <script>
  function updateInstitutionMetadata(institutionId) {
      fetch(`/api/institution_metadata/${institutionId}`)
          .then(response => response.json())
          .then(data => {
              // Update last transaction
              document.getElementById(`last-transaction-${institutionId}`).textContent = 
                  data.last_transaction ? new Date(data.last_transaction).toLocaleString() : 'Never';
              
              // Update last refresh
              document.getElementById(`last-refresh-${institutionId}`).textContent = 
                  data.last_refresh ? new Date(data.last_refresh).toLocaleString() : 'Never';
              
              // Update new transactions count
              document.getElementById(`last-credit-${institutionId}`).textContent = 
                  `${data.new_transactions} new transactions`;
              
              // Update connected on
              document.getElementById(`connected-on-${institutionId}`).textContent = 
                  data.connected_on ? new Date(data.connected_on).toLocaleString() : 'Never';
                
              // Update account data
              document.getElementById(`account-count-${institutionId}`).textContent = 
                  data.account_count;
              document.getElementById(`transaction-count-${institutionId}`).textContent = 
                  data.transaction_count;
              document.getElementById(`uncategorized-count-${institutionId}`).textContent = 
                  data.uncategorized_count;
          })
          .catch(error => {
              console.error('Error:', error);
              ['last-transaction', 'last-refresh', 'last-credit', 'connected-on',
               'account-count', 'transaction-count', 'uncategorized-count'].forEach(field => {
                  document.getElementById(`${field}-${institutionId}`).textContent = 'Error';
              });
          });
  }

  // Update metadata for all institutions when page loads
  document.addEventListener('DOMContentLoaded', () => {
      const institutions = document.querySelectorAll('.institution-container');
      institutions.forEach(inst => {
          const institutionId = inst.querySelector('.remove-institution').dataset.institutionId;
          updateInstitutionMetadata(institutionId);
      });
  });
  </script>
  <script>
  // Function to update database statistics
  function updateDatabaseStatistics() {
      console.log("Fetching database statistics...");
      return new Promise((resolve, reject) => {
          $.ajax({
              url: '/api/database_statistics',
              method: 'GET',
              success: function(statsData) {
                  console.log("Received statistics:", statsData);
                  const tbody = document.querySelector('#database-stats-table tbody');
                  tbody.innerHTML = ''; // Clear existing rows
                  
                  if (statsData.error) {
                      console.error("Error in statistics:", statsData.error);
                      tbody.innerHTML = `<tr><td colspan="2">Error: ${statsData.error}</td></tr>`;
                      reject(statsData.error);
                      return;
                  }
                  
                  Object.entries(statsData)
                      .sort(([,a], [,b]) => b - a)
                      .forEach(([name, count]) => {
                          const row = document.createElement('tr');
                          const isView = name.includes('(view)');
                          const displayName = name.replace(/ \((view|table)\)$/, '').replace(/_/g, ' ');
                          
                          row.innerHTML = `
                              <td class="${isView ? 'view-name' : 'table-name'}">
                                  ${displayName}${isView ? ' (view)' : ''}
                              </td>
                              <td>${count}</td>
                          `;
                          tbody.appendChild(row);
                      });
                  resolve();
              },
              error: function(xhr, status, error) {
                  console.error("Ajax error:", {xhr, status, error});
                  const tbody = document.querySelector('#database-stats-table tbody');
                  tbody.innerHTML = '<tr><td colspan="2">Error loading statistics</td></tr>';
                  reject(error);
              }
          });
      });
  }

  // Instead, just do an initial load when the page loads
  document.addEventListener('DOMContentLoaded', updateDatabaseStatistics);
  </script>
</body>
</html>
